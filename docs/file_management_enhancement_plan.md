# 文件管理优化功能实施计划

## 方案概述

本文档详细描述了音频翻译器应用程序文件管理功能优化的实施计划。主要目标是增强文件显示和管理功能，特别是围绕文件名翻译这一核心功能进行优化。

### 主要功能需求

1. **添加翻译结果列**：在文件列表中显示翻译后的文件名
2. **文件选择功能**：增强单选和多选文件的用户体验 ✅
3. **文件名编辑功能**：支持双击编辑单个文件名和批量编辑文件名
4. **翻译功能集成**：将翻译服务集成到文件管理界面
5. **翻译质量与效率**：添加翻译缓存、服务切换、智能分析等功能
6. **用户体验优化**：改进界面交互、添加搜索过滤和导出功能

## 实施步骤

### 第一阶段：创建FileManagerPanel组件

**目标**：创建一个专门的`FileManagerPanel`类作为独立UI组件，负责文件显示和管理。

#### 任务清单

1. **创建基础文件结构**
   - [x] 创建`src/audio_translator/gui/panels/file_manager_panel.py`文件
   - [x] 创建`FileManagerPanel`类，继承自`ttk.Frame`
   - [x] 定义基本属性和初始化方法

2. **实现基础UI组件**
   - [x] 创建文件树视图，添加所有必要的列（文件名、翻译结果、类型、状态）
   - [x] 创建工具栏，包含常用操作按钮
   - [x] 创建状态栏，显示操作信息和统计数据
   - [x] 实现基本的右键菜单

3. **实现与FileManager的连接**
   - [x] 在初始化时接收FileManager实例
   - [x] 实现文件加载和显示功能
   - [x] 实现文件选择事件处理

4. **集成到主窗口**
   - [x] 修改`main_window.py`，使用新的`FileManagerPanel`组件
   - [x] 确保现有功能正常工作

### 第二阶段：扩展FileManager类与实现翻译基础功能

**目标**：扩展`FileManager`类，添加与翻译相关的方法和事件，实现基本翻译功能。

#### 任务清单

1. **添加翻译相关字段**
   - [ ] 在文件元数据中添加`translated_name`字段
   - [ ] 调整文件加载和处理方法，支持新字段

2. **添加翻译状态追踪**
   - [ ] 添加翻译状态枚举（未翻译、翻译中、已翻译、失败）
   - [ ] 实现翻译状态更新方法
   - [ ] 添加状态指示图标

3. **增强文件管理功能**
   - [x] 实现批量操作方法（选择、过滤、排序）
   - [ ] 添加文件名修改方法（单个和批量）

4. **添加事件机制**
   - [x] 定义文件管理相关事件（文件加载、选择、修改、翻译）
   - [x] 实现事件通知机制

### 第三阶段：增强翻译功能

**目标**：集成翻译服务，在UI中实现高级翻译功能。

#### 任务清单

1. **集成翻译服务**
   - [ ] 在`FileManagerPanel`中添加对`TranslatorService`的引用
   - [ ] 实现单个文件名翻译方法
   - [ ] 实现批量文件名翻译方法

2. **添加翻译UI**
   - [x] 添加翻译按钮/菜单项
   - [ ] 实现翻译进度显示
   - [ ] 添加翻译结果列和视图

3. **实现翻译服务切换**
   - [ ] 添加翻译服务选择下拉菜单
   - [ ] 实现服务切换逻辑
   - [ ] 显示当前服务连接状态

4. **实现翻译工作流**
   - [ ] 创建独立的翻译队列管理器
   - [ ] 实现翻译任务暂停/恢复控制
   - [ ] 添加翻译成功/失败处理
   - [ ] 实现错误重试机制（自动和手动）

5. **智能文件名分析**
   - [ ] 实现文件名分段分析功能
   - [ ] 识别并保留不需要翻译的部分（数字、代码）
   - [ ] 针对有意义的部分进行翻译

6. **翻译质量管理**
   - [ ] 添加翻译质量反馈收集功能
   - [ ] 实现用户修正翻译记录
   - [ ] 添加翻译质量/速度平衡控制

### 第四阶段：实现文件名编辑功能

**目标**：实现双击编辑和批量编辑文件名功能。

#### 任务清单

1. **实现单个文件编辑**
   - [ ] 为翻译结果列添加双击编辑事件
   - [ ] 创建内联编辑控件
   - [ ] 实现编辑确认和取消功能

2. **实现批量编辑**
   - [ ] 创建批量编辑对话框
   - [ ] 实现不同的批量编辑模式（替换、添加前缀/后缀、正则替换）
   - [ ] 添加批量编辑预览功能

3. **添加基本撤销功能**
   - [ ] 实现简单的撤销最后操作功能
   - [ ] 添加撤销按钮

### 第五阶段：增强用户体验

**目标**：添加辅助功能，提升整体用户体验。

#### 任务清单

1. **增强搜索和过滤**
   - [x] 实现按原文件名搜索
   - [ ] 实现按翻译结果搜索
   - [ ] 添加高级过滤选项（类型、状态、翻译状态）

2. **添加导出功能**
   - [ ] 实现导出翻译结果为CSV/Excel
   - [ ] 实现导出设置对话框

3. **改进UI/UX**
   - [ ] 添加拖放支持
   - [x] 实现列宽调整和自动记忆保存
   - [ ] 添加键盘快捷键
   - [ ] 改进状态显示（使用颜色区分不同状态）
   - [x] 添加操作过程中的视觉反馈

4. **可选功能**
   - [ ] 简单的音频文件预览功能
   - [ ] 批量重命名脚本导出
   - [ ] 完整的编辑历史记录

## 测试计划

### 单元测试

- [ ] 为`FileManager`扩展功能编写单元测试
- [ ] 为翻译集成功能编写单元测试
- [ ] 为文件名处理功能编写单元测试
- [ ] 为翻译缓存机制编写单元测试

### 功能测试

- [x] 测试文件加载和显示功能
- [x] 测试文件选择（单选/多选）功能
- [ ] 测试翻译功能和翻译结果显示
- [ ] 测试翻译缓存与持久化功能
- [ ] 测试不同翻译服务切换的稳定性
- [ ] 测试文件名编辑功能（单个和批量）
- [x] 测试搜索和过滤功能
- [ ] 测试导出功能

### 用户体验和性能测试

- [x] 评估界面响应速度
- [x] 测试大文件列表的处理性能
- [ ] 测试大批量文件翻译的稳定性和性能
- [ ] 测试网络不稳定情况下的错误恢复能力
- [x] 评估批量操作的用户体验
- [ ] 测试不同屏幕尺寸下的UI适应性

## 最近完成的改进

1. **文件选择功能增强**
   - 添加了独立的选择列，提供直观的选择状态视觉反馈
   - 实现了全选、反选和取消选择功能
   - 修复了状态栏更新逻辑，确保正确显示选中文件数量
   - 优化了多选操作的用户体验和响应性能

2. **界面功能完善**
   - 修复了列设置对话框功能，使其能够正确记忆和应用用户设置
   - 改进了文件大小格式化显示
   - 添加了编辑和翻译按钮，以便快速操作选中文件
   - 修复了异步加载过程中的错误处理

## 注意事项

1. **核心功能优先**：优先实现翻译和基本编辑功能，确保核心流程顺畅
2. **向后兼容性**：确保新功能不破坏现有功能
3. **错误处理**：为所有操作添加适当的错误处理和用户反馈
4. **性能考虑**：优化大文件列表和翻译队列的处理性能
5. **用户偏好**：保存用户设置和偏好
6. **模块化设计**：将翻译功能与UI交互分离，便于后期维护

## 参考资源

- 现有的`FileManager`类：`src/audio_translator/managers/file_manager.py`
- 现有的主窗口实现：`src/audio_translator/gui/main_window.py`
- 翻译服务：`src/audio_translator/services/business/translator_service.py`
- UI组件规范：`src/audio_translator/gui/panels/service_manager_panel.py`

## 完成标准

1. 所有核心功能都已实现并通过测试（非可选功能）
2. 代码符合项目的编码规范和风格
3. 文档已更新，包括使用说明和API文档
4. 性能满足要求，不会因大文件列表而明显变慢
5. 用户反馈已收集并处理 

## 下一步开发重点

1. **翻译结果列实现**：添加翻译结果列并集成翻译服务
2. **文件名编辑功能**：实现单个和批量文件名编辑功能
3. **翻译工作流优化**：建立高效的翻译队列和状态管理机制 